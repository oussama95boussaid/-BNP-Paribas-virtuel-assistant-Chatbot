# # ============================================================================
# # Azure Container Instance Deployment - BNP Paribas Assistant
# # ============================================================================
# # This workflow:
# # 1. Builds Docker image
# # 2. Pushes to Azure Container Registry (ACR)
# # 3. Deploys to Azure Container Instance (ACI)
# # 4. Runs health checks
# # ============================================================================

# name: Deploy to Azure Container Instance

# on:
#   push:
#     branches: [ main ]
#     paths:
#       - 'Backend_server/**'
#       - '.github/workflows/azure-deploy.yml'
#   workflow_dispatch:  # Allow manual trigger

# env:
#   AZURE_RESOURCE_GROUP: bnp-assistant-rg
#   ACR_NAME: bnpassistantacr
#   ACR_LOGIN_SERVER: bnpassistantacr.azurecr.io
#   CONTAINER_NAME: bnp-assistant-container
#   IMAGE_NAME: bnp-assistant
#   DNS_NAME_LABEL: bnp-assistant-api-oussama
#   LOCATION: eastus

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     # ========================================
#     # 1. Checkout Code
#     # ========================================
#     - name: üì• Checkout code
#       uses: actions/checkout@v3

#     # ========================================
#     # 2. Azure Login
#     # ========================================
#     - name: üîê Azure Login
#       uses: azure/login@v1
#       with:
#         creds: ${{ secrets.AZURE_CREDENTIALS }}

#     # ========================================
#     # 3. Login to Azure Container Registry
#     # ========================================
#     - name: üê≥ Login to ACR
#       run: |
#         az acr login --name ${{ env.ACR_NAME }}

#     # ========================================
#     # 4. Build and Push Docker Image
#     # ========================================
#     - name: üèóÔ∏è Build and push Docker image
#       working-directory: ./Backend_server
#       run: |
#         # Build image
#         docker build -t ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
#                      -t ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest \
#                      .
        
#         # Push both tags
#         docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
#         docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest

#     # ========================================
#     # 5. Get ACR Credentials
#     # ========================================
#     - name: üîë Get ACR credentials
#       id: acr-creds
#       run: |
#         ACR_USERNAME=$(az acr credential show --name ${{ env.ACR_NAME }} --query username -o tsv)
#         ACR_PASSWORD=$(az acr credential show --name ${{ env.ACR_NAME }} --query passwords[0].value -o tsv)
#         echo "::add-mask::$ACR_PASSWORD"
#         echo "username=$ACR_USERNAME" >> $GITHUB_OUTPUT
#         echo "password=$ACR_PASSWORD" >> $GITHUB_OUTPUT

#     # ========================================
#     # 6. Delete Old Container Instance (if exists)
#     # ========================================
#     - name: üóëÔ∏è Delete old container instance
#       run: |
#         az container delete \
#           --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
#           --name ${{ env.CONTAINER_NAME }} \
#           --yes \
#           || echo "No existing container to delete"

#     # ========================================
#     # 7. Deploy to Azure Container Instance
#     # ========================================
#     - name: üöÄ Deploy to Azure Container Instance
#       run: |
#         az container create \
#           --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
#           --name ${{ env.CONTAINER_NAME }} \
#           --image ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest \
#           --cpu 2 \
#           --memory 4 \
#           --os-type Linux \
#           --registry-login-server ${{ env.ACR_LOGIN_SERVER }} \
#           --registry-username ${{ steps.acr-creds.outputs.username }} \
#           --registry-password ${{ steps.acr-creds.outputs.password }} \
#           --dns-name-label ${{ env.DNS_NAME_LABEL }} \
#           --ports 8000 \
#           --environment-variables \
#             OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
#           --location ${{ env.LOCATION }} \
#           --restart-policy Always

#     # ========================================
#     # 8. Get Container URL
#     # ========================================
#     - name: üåê Get container URL
#       id: get-url
#       run: |
#         FQDN=$(az container show \
#           --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
#           --name ${{ env.CONTAINER_NAME }} \
#           --query ipAddress.fqdn -o tsv)
        
#         echo "CONTAINER_URL=http://${FQDN}:8000" >> $GITHUB_OUTPUT
#         echo "### üéâ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
#         echo "" >> $GITHUB_STEP_SUMMARY
#         echo "**Backend URL:** http://${FQDN}:8000" >> $GITHUB_STEP_SUMMARY
#         echo "**Health Check:** http://${FQDN}:8000/health" >> $GITHUB_STEP_SUMMARY
#         echo "**Query Endpoint:** http://${FQDN}:8000/query" >> $GITHUB_STEP_SUMMARY

#     # ========================================
#     # 9. Wait for Container Startup
#     # ========================================
#     - name: ‚è≥ Wait for container startup
#       run: |
#         echo "Waiting 60 seconds for container initialization..."
#         sleep 60

#     # ========================================
#     # 10. Health Check
#     # ========================================
#     - name: üè• Health check
#       run: |
#         FQDN=$(az container show \
#           --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
#           --name ${{ env.CONTAINER_NAME }} \
#           --query ipAddress.fqdn -o tsv)
        
#         echo "Testing health endpoint..."
#         HEALTH_RESPONSE=$(curl -f http://${FQDN}:8000/health || echo "FAILED")
        
#         if [ "$HEALTH_RESPONSE" = "FAILED" ]; then
#           echo "‚ùå Health check failed!"
#           az container logs \
#             --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
#             --name ${{ env.CONTAINER_NAME }}
#           exit 1
#         fi
        
#         echo "‚úÖ Health check passed!"
#         echo "$HEALTH_RESPONSE"

#     # ========================================
#     # 11. View Container Logs (on failure)
#     # ========================================
#     - name: üìã View container logs
#       if: failure()
#       run: |
#         echo "Fetching container logs..."
#         az container logs \
#           --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
#           --name ${{ env.CONTAINER_NAME }} \
#           || echo "Could not fetch logs"

#     # ========================================
#     # 12. Deployment Summary
#     # ========================================
#     - name: üìä Deployment summary
#       if: success()
#       run: |
#         echo "============================================"
#         echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
#         echo "============================================"
#         echo "Image: ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest"
#         echo "Git SHA: ${{ github.sha }}"
#         echo "Container URL: ${{ steps.get-url.outputs.CONTAINER_URL }}"
#         echo "Deployed to: ${{ env.LOCATION }}"
#         echo "============================================"
